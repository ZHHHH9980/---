# redux-saga

> redux中间件，相比redux-thunk更方便管理大型项目；



## saga种类

### 1.rootSaga 

`store`中引入，所有的saga入口；

```js
// store/index.js
import { createStore, applyMiddleware } from "redux";
import reducers from "./reducers";
import createSagaMiddleware from "redux-saga";
import rootSaga from "./saga";

const sagaMiddleware = createSagaMiddleware();
const store = applyMiddleware(sagaMiddleware)(createStore)(reducers);
sagaMiddleware.run(rootSaga);

export default store;
```



```js
// saga/index.js
import { all } from "redux-saga/effects";

export default function* rootSaga() {
  yield all([helloSaga(), watchAsyncIncrement()]);
}
```



### 2.watchSaga

负责监听相应的动作，通知workerSaga执行；

```js
export default function* watchAsyncIncrement() {
  // 监听每次ASYNC_INCREMENT动作 执行incrementAsync
  yield takeEvery(actionTypes.ASYNC_INCREMENT, incrementAsync);
}
```



### 3.workerSaga

```js
import { put } from "redux-saga/effects";

export function* incrementAsync() {
  // put 就相当于dispatch，每次调用都会dispatch 响应type的事件
  yield put({ type: actionTypes.INCREMENT });
}
```



### 为什么要用generator?

generator的特点是每当识别到yield关键字就会**暂停执行函数**，让出调用栈；

根据这个特点，redux-saga内部就会根据这个特性，**自动执行完整个流程，而且表现上就是同步在执行函数（异步管理）**；

```js
export function* incrementAsync() {
  // 异步获取数据
  let msg = yield call(getData);
    
  // redux-saga监听到返回对象才会继续执行
  yield put({ type: actionTypes.INCREMENT, payload: msg });
}
```



## saga单元测试

因为generator的特性，saga单元测试非常方便；

```js
import test from "tape";

test("incrementAsync saga test", function (assert) {
  let it = incrementAsync();
  assert.deepEqual(it.next().value, delay(1000), "incrementAsync first");
  assert.end();
});
```



## api

### take takeEvery

`takeEvery`监听每一次动作执行，`take`仅监听一次；`takeEvery`实际上是`take`的语法糖；

```js
export default function* watchAsyncIncrement() { 
  yield takeEvery(actionTypes.ASYNC_INCREMENT, incrementAsync);
}
```

//=> 等价写法

```js
export default function* watchAsyncIncrement() { 
    while (true) {
        yield take(actionTypes.ASYNC_INCREMENT, incrementAsync);
      }
}
```



### select

获取当前状态树

```js
const counter = yield select(state => state.counter)
```

